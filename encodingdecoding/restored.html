<!DOCTYPE html>
<html lang="en">
<head>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-37VRZ5CGE4"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-37VRZ5CGE4');
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="pageTitle">Database Management | NBI Green Economy</title>
  <link rel="stylesheet" href="../public/Master Page(Header and Footer)/MasterPage.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/i18next@23.11.5/dist/umd/i18next.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.1.0/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', sans-serif;
      color: #333;
      background-color: #f8f9fa;
      overflow-x: hidden;
    }
    .container {
      width: 95%;
      max-width: 1800px;
      margin: 0 auto;
      padding: 0 15px;
      opacity: 0;
      animation: fadeIn 0.5s ease-in forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    header {
      background-color: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px 0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo img {
      height: 50px;
    }
    .logo-text {
      font-weight: 700;
      font-size: 1.5rem;
    }
    .dashboard {
      padding: 30px 0;
    }
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }
    .dashboard-title {
      font-size: 2rem;
      font-weight: 700;
      color: #2b9589;
    }
    .action-buttons {
      display: flex;
      gap: 15px;
    }
    .btn {
      padding: 10px 20px;
      border-radius: 4px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
      border: none;
    }
    .btn-primary {
      background-color: #2b9589;
      color: white;
    }
    .btn-primary:hover {
      background-color: #4ec3b0;
    }
    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    .search-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .search-input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      width: 200px;
    }
    .search-input:focus {
      outline: none;
      border-color: #2b9589;
      box-shadow: 0 0 5px rgba(43, 149, 137, 0.3);
    }
    .category-selector {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }
    .category-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .category-tab {
      padding: 10px 20px;
      background: #f1f1f1;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }
    .category-tab:hover {
      background: #e0e0e0;
    }
    .category-tab.active {
      background: #2b9589;
      color: white;
    }
    .data-table-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      overflow-x: auto;
      border: 1px solid #2b9589;
    }
    .data-table {
      width: 100%;
      min-width: 2000px;
      border-collapse: separate;
      border-spacing: 0;
    }
    .data-table th,
    .data-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
      border-right: 1px solid #eee;
    }
    .data-table th {
      background-color: #f8f6f0;
      font-weight: 600;
      position: sticky;
      top: 0;
      color: #333;
      border-bottom: 2px solid #2b9589;
    }
    .data-table th:last-child,
    .data-table td:last-child {
      border-right: none;
    }
    .data-table tr:hover {
      background-color: rgba(43, 149, 137, 0.05);
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    .loading-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2b9589;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    .loading-text {
      color: white;
      margin-top: 10px;
      font-size: 1.2rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .no-results {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 5px;
    }
    .page-btn {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      border-radius: 4px;
    }
    .page-btn.active {
      background-color: #2b9589;
      color: white;
      border-color: #2b9589;
    }
    .page-btn:hover:not(.active) {
      background-color: #f1f1f1;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background: white;
      border-radius: 8px;
      width: 95%;
      max-width: 1200px;
      max-height: 90vh;
      padding: 20px;
      position: relative;
      transform: translateY(-20px);
      transition: transform 0.3s;
      overflow-y: auto;
      border: 2px solid #2b9589;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
      position: sticky;
      top: 0;
      background: white;
      z-index: 1;
    }
    .modal-title {
      font-size: 1.5rem;
      color: #000;
      margin: 0;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #666;
      transition: color 0.3s;
    }
    .modal-close:hover {
      color: #2b9589;
    }
    .modal-body {
      padding: 10px 0;
    }
    .detail-section {
      margin-bottom: 20px;
    }
    .detail-section h3 {
      color: #2b9589;
      margin-bottom: 15px;
      padding-bottom: 5px;
      border-bottom: 1px solid #eee;
    }
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }
    .detail-item {
      margin-bottom: 10px;
    }
    .detail-label {
      font-weight: 600;
      color: #555;
      margin-bottom: 3px;
    }
    .detail-value {
      padding: 5px;
      background: #f8f8f8;
      border-radius: 4px;
    }
    .language-switcher {
      position: absolute;
      right: 20px;
      top: 20px;
    }
    .language-switcher select {
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    @media (max-width: 1200px) {
      .data-table-container {
        overflow-x: auto;
      }
      .data-table {
        min-width: 2000px;
      }
    }
    @media (max-width: 768px) {
      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .action-buttons {
        width: 100%;
        justify-content: flex-end;
      }
      .category-tabs {
        overflow-x: auto;
        padding-bottom: 10px;
        flex-wrap: nowrap;
      }
      .modal-content {
        width: 98%;
        max-height: 85vh;
      }
    }
    @media (max-width: 576px) {
      .btn {
        padding: 8px 12px;
        font-size: 14px;
      }
      .modal-content {
        width: 100%;
        max-height: 80vh;
        padding: 15px;
      }
      .detail-grid {
        grid-template-columns: 1fr;
      }
      .search-input {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="pageLoading">
    <div class="loading-spinner"></div>
    <div class="loading-text" data-i18n="loadingText">Loading...</div>
  </div>
  <green-economy-header></green-economy-header>
  <section class="dashboard">
    <div class="container">
      <div class="language-switcher">
        <select id="languageSelect">
          <option value="en">English</option>
          <option value="fr">Fran√ßais</option>
        </select>
      </div>
      <div class="dashboard-header">
        <h1 class="dashboard-title" data-i18n="dashboardTitle">Project Database Management</h1>
        <div class="action-buttons" id="actionButtons">
          <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="Search projects..." data-i18n="[placeholder]searchPlaceholder">
          </div>
          <input type="file" id="excelUpload" accept=".xlsx" style="display: none;">
          <button id="uploadBtn" class="btn btn-primary" data-i18n="[html]uploadButton">
            <i class="bi bi-upload"></i> Upload Excel
          </button>
          <button id="exportBtn" class="btn btn-primary" data-i18n="[html]exportButton">
            <i class="bi bi-download"></i> Export Data
          </button>
          <button id="refreshBtn" class="btn btn-secondary" data-i18n="[html]refreshButton">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
      </div>
      <div class="category-selector">
        <h3 data-i18n="categorySelectorTitle">Select Data Categories to Display</h3>
        <div class="category-tabs" id="categoryTabs"></div>
      </div>
      <div class="data-table-container">
        <div id="loadingIndicator" class="loading-indicator">
          <div class="spinner"></div>
          <p data-i18n="loadingProjects">Loading project data...</p>
        </div>
        <table class="data-table">
          <thead id="tableHeader"></thead>
          <tbody id="tableBody"></tbody>
        </table>
        <div id="noResults" class="no-results" style="display: none;" data-i18n="noResults">
          No projects found matching your criteria.
        </div>
      </div>
      <div class="pagination" id="pagination"></div>
    </div>
  </section>
  <div class="modal-overlay" id="projectModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="projectDetailsTitle">Project Details</h2>
        <button class="modal-close" id="closeModal">&times;</button>
      </div>
      <div class="modal-body" id="projectDetails"></div>
    </div>
  </div>
  <script>
    // Translation initialization
    i18next
      .use(i18nextBrowserLanguageDetector)
      .init({
        fallbackLng: 'en',
        debug: false,
        resources: {
          en: {
            translation: {
              pageTitle: "Database Management | NBI Green Economy",
              dashboardTitle: "Project Database Management",
              searchPlaceholder: "Search projects...",
              uploadButton: "<i class='bi bi-upload'></i> Upload Excel",
              exportButton: "<i class='bi bi-download'></i> Export Data",
              refreshButton: "<i class='bi bi-arrow-clockwise'></i> Refresh",
              categorySelectorTitle: "Select Data Categories to Display",
              loadingProjects: "Loading project data...",
              noResults: "No projects found matching your criteria.",
              projectDetailsTitle: "Project Details",
              loadingText: "Loading...",
              errorLoadingProjects: "Error loading projects",
              noDataToExport: "No data to export",
              noFileSelected: "No file selected",
              confirmOverwrite: "Data already exists. Overwrite?",
              uploadSuccess: "Successfully uploaded {count} projects",
              uploadSuccessWithIds: "Successfully uploaded {count} projects, {idCount} with generated IDs",
              errorUploadingExcel: "Error uploading Excel: {message}",
              errorReadingFile: "Error reading file",
              viewButton: "View",
              actionsHeader: "Actions"
            }
          },
          fr: {
            translation: {
              pageTitle: "Gestion de la base de donn√©es | NBI √âconomie Verte",
              dashboardTitle: "Gestion de la base de donn√©es des projets",
              searchPlaceholder: "Rechercher des projets...",
              uploadButton: "<i class='bi bi-upload'></i> T√©l√©charger Excel",
              exportButton: "<i class='bi bi-download'></i> Exporter les donn√©es",
              refreshButton: "<i class='bi bi-arrow-clockwise'></i> Actualiser",
              categorySelectorTitle: "S√©lectionner les cat√©gories de donn√©es √† afficher",
              loadingProjects: "Chargement des donn√©es des projets...",
              noResults: "Aucun projet trouv√© correspondant √† vos crit√®res.",
              projectDetailsTitle: "D√©tails du projet",
              loadingText: "Chargement...",
              errorLoadingProjects: "Erreur lors du chargement des projets",
              noDataToExport: "Aucune donn√©e √† exporter",
              noFileSelected: "Aucun fichier s√©lectionn√©",
              confirmOverwrite: "Des donn√©es existent d√©j√†. Remplacer ?",
              uploadSuccess: "{count} projets t√©l√©charg√©s avec succ√®s",
              uploadSuccessWithIds: "{count} projets t√©l√©charg√©s avec succ√®s, {idCount} avec des ID g√©n√©r√©s",
              errorUploadingExcel: "Erreur lors du t√©l√©chargement d'Excel : {message}",
              errorReadingFile: "Erreur lors de la lecture du fichier",
              viewButton: "Voir",
              actionsHeader: "Actions"
            }
          }
        }
      }, function(err, t) {
        if (err) console.error('i18next initialization failed:', err);
        updateContent();
      });

    // Update content with translations
    function updateContent() {
      document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (key.includes('[html]')) {
          element.innerHTML = i18next.t(key.replace('[html]', ''));
        } else if (key.includes('[placeholder]')) {
          element.placeholder = i18next.t(key.replace('[placeholder]', ''));
        } else {
          element.textContent = i18next.t(key);
        }
      });
    }

    // Language switcher
    document.getElementById('languageSelect').addEventListener('change', (e) => {
      i18next.changeLanguage(e.target.value, () => {
        updateContent();
      });
    });

    // Show loading overlay
    function showLoadingOverlay() {
      document.getElementById('pageLoading').classList.add('active');
    }

    // Hide loading overlay
    function hideLoadingOverlay() {
      document.getElementById('pageLoading').classList.remove('active');
    }

    // Column categories
    const columnCategories = {
      "Project Information": [
        "Project Code", "Project Name", "Programme Start", "Programme End",
        "TVET College", "Project Status", "GIZ Enrollment Number",
        "GIZ Enrollment Date", "Type of support / programme"
      ],
      "Beneficiary Details": [
        "Identity / Passport Number", "First Name/s:", "Surname", "Date of Birth",
        "Age", "Gender", "Ethnicity", "Nationality", "Disability", "Disability Type"
      ],
      "Contact Information": [
        "Residential Address", "Township/Rural Location", "Province",
        "Local Municipality", "District Municipality", "Postal code",
        "Cell Number", "WhatsApp Number (if applicable)", "Email Address",
        "Preferred contact method", "IRM Platform Notifications"
      ],
      "Education & Employment": [
        "Education Level", "Highest educational qualification attained.",
        "Name of Highest educational qualification attained", "Year Obtained",
        "Employment Status", "Position in Company/ Job Title"
      ],
      "Business Ownership": [
        "Business Ownership Interest", "Number of Other Business Owners",
        "Secondary Business Contact  First Name/s:", "Secondary Business Contact  Surname",
        "Secondary Business Contact Cell Number"
      ],
      "Business Details": [
        "Business Name", "Business Operating Start Date", "Years in Business",
        "Legal  Type of business entity", "Business Core Products and Services",
        "Business Registration status", "Business  Registration number",
        "Business date of registration", "Business Financial Year-End",
        "Copy of CIPC registration certificate"
      ],
      "Tax & Compliance": [
        "Business  Tax Registration Status", "Business Income Tax reference number",
        "Tax compliance PIN expiry date", "Copy of Tax clearance certificate)",
        "Business Website Address"
      ],
      "Business Location": [
        "Business Address ", "Type of Business Premises", "Township/Rural Location",
        "Province", "Local Municipality", "Ward Number", "District Municipality ",
        "Postal code", "TVET College nearest to the business location:"
      ],
      "Financial & BBBEE": [
        "Business Annual Revenue (Last Financial Year-End)", "BBBEE Classification",
        "BBBEE Level of Contribution", "Copy of BBBEE certificate / Affidavit",
        "BBBEE certificate / Affidavit expiry date", "Black Ownership and Management Control",
        "Black Female Ownership", "Black Youth Ownership", "Disabled Ownership"
      ],
      "Market & Workforce": [
        "Main Market/Revenue Source", "Type of  Main Market/Revenue Source",
        "Market Geographic Reach", "Total Number of Employees",
        "Total Number of Female Employees", "Total Number of Youth Employees",
        "Total Number of Black Employees"
      ],
      "Training & Development": [
        "Does the business have a history of Hosting Learners/Apprentices",
        "Name of the last Organization that provided the Learners/Apprentices?",
        "Total number of Learners/Apprentices hosted", "Hosting period",
        "Does the business have an interest and capacity to Host Learners/Apprentices?",
        "Total number of Learners/Apprentices the business wants to host",
        "Hosting period"
      ],
      "Enterprise Development": [
        "Does the business have a history of  Enterprise Development",
        "Name of the last Organization that provided Enterprise Development",
        "Enterprise Development period", "Received Enterprise Development Support",
        "Type of Access to Finance Received", "Name of the Organization that Provided the Finance",
        "Value of Finance Received"
      ]
    };

    // DOM Elements
    const categoryTabs = document.getElementById('categoryTabs');
    const tableHeader = document.getElementById('tableHeader');
    const tableBody = document.getElementById('tableBody');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const noResults = document.getElementById('noResults');
    const pagination = document.getElementById('pagination');
    const projectModal = document.getElementById('projectModal');
    const closeModal = document.getElementById('closeModal');
    const projectDetails = document.getElementById('projectDetails');
    const exportBtn = document.getElementById('exportBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const excelUpload = document.getElementById('excelUpload');
    const searchInput = document.getElementById('searchInput');

    // Global variables
    let currentColumns = ["Project Code", "Project Name", "TVET College", "Project Status"];
    let currentPage = 1;
    const projectsPerPage = 10;
    let allProjects = [];
    let filteredProjects = [];

    // Initialize dashboard
    async function initializeDashboard() {
      showLoadingOverlay();
      try {
        const response = await fetch('/api/projects');
        if (!response.ok) throw new Error('Failed to load projects');
        allProjects = await response.json();
        filteredProjects = [...allProjects];
        console.log('Projects loaded:', filteredProjects.length);
        const hasData = allProjects.length > 0;
        if (hasData) {
          console.log('Data exists, hiding upload button');
          uploadBtn.style.display = 'none';
          excelUpload.style.display = 'none';
        }
        initCategoryTabs();
        displayProjects();
      } catch (error) {
        console.error('Error loading projects:', error);
        alert(i18next.t('errorLoadingProjects'));
      } finally {
        hideLoadingOverlay();
      }
    }

    // Initialize category tabs
    function initCategoryTabs() {
      console.log('Initializing category tabs');
      for (const category in columnCategories) {
        const tab = document.createElement('div');
        tab.className = 'category-tab';
        if (category === "Project Information") tab.classList.add('active');
        tab.textContent = category;
        tab.dataset.category = category;
        tab.addEventListener('click', toggleCategory);
        categoryTabs.appendChild(tab);
      }
    }

    // Toggle category visibility
    function toggleCategory(e) {
      console.log('Toggling category:', e.target.dataset.category);
      const category = e.target.dataset.category;
      e.target.classList.toggle('active');
      if (e.target.classList.contains('active')) {
        columnCategories[category].forEach(col => {
          if (!currentColumns.includes(col)) currentColumns.push(col);
        });
      } else {
        currentColumns = currentColumns.filter(col => !columnCategories[category].includes(col));
      }
      if (!currentColumns.includes("Project Code")) currentColumns.unshift("Project Code");
      displayProjects();
    }

    // Load projects from server
    async function loadProjects() {
      console.log('Loading projects from server');
      loadingIndicator.style.display = 'block';
      try {
        const response = await fetch('/api/projects');
        if (!response.ok) throw new Error('Failed to load projects');
        allProjects = await response.json();
        filteredProjects = [...allProjects];
        console.log('Projects loaded:', filteredProjects.length);
        displayProjects();
      } catch (error) {
        console.error('Error loading projects:', error);
        alert(i18next.t('errorLoadingProjects'));
      } finally {
        loadingIndicator.style.display = 'none';
      }
    }

    // Refresh data
    function refreshData() {
      console.log('Refreshing data');
      loadingIndicator.style.display = 'block';
      tableBody.innerHTML = '';
      searchInput.value = '';
      loadProjects();
    }

    // Display projects in the table
    function displayProjects() {
      console.log('Displaying projects:', filteredProjects.length);
      updateTableHeader();
      tableBody.innerHTML = '';
      if (filteredProjects.length === 0) {
        console.log('No projects to display');
        noResults.style.display = 'block';
        pagination.innerHTML = '';
        return;
      }
      noResults.style.display = 'none';
      const totalPages = Math.ceil(filteredProjects.length / projectsPerPage);
      const startIndex = (currentPage - 1) * projectsPerPage;
      const endIndex = Math.min(startIndex + projectsPerPage, filteredProjects.length);
      const paginatedProjects = filteredProjects.slice(startIndex, endIndex);
      paginatedProjects.forEach(project => {
        const row = document.createElement('tr');
        currentColumns.forEach(column => {
          const cell = document.createElement('td');
          cell.textContent = project[column] || '-';
          row.appendChild(cell);
        });
        const actionCell = document.createElement('td');
        const viewBtn = document.createElement('button');
        viewBtn.className = 'btn btn-primary';
        viewBtn.style.padding = '5px 10px';
        viewBtn.innerHTML = '<i class="bi bi-eye"></i> ' + i18next.t('viewButton');
        viewBtn.addEventListener('click', () => viewProjectDetails(project["Project Code"] || project["New project name"] || project["Oroginal Project name"]));
        actionCell.appendChild(viewBtn);
        row.appendChild(actionCell);
        tableBody.appendChild(row);
      });
      generatePagination(totalPages);
    }

    // Update table header
    function updateTableHeader() {
      console.log('Updating table header with columns:', currentColumns);
      tableHeader.innerHTML = '';
      const headerRow = document.createElement('tr');
      currentColumns.forEach(column => {
        const th = document.createElement('th');
        th.textContent = column;
        headerRow.appendChild(th);
      });
      const actionTh = document.createElement('th');
      actionTh.textContent = i18next.t('actionsHeader');
      headerRow.appendChild(actionTh);
      tableHeader.appendChild(headerRow);
    }

    // View project details in modal
    function viewProjectDetails(projectCode) {
      console.log('Viewing project details for:', projectCode);
      const project = filteredProjects.find(p =>
        p["Project Code"] === projectCode ||
        p["New project name"] === projectCode ||
        p["Oroginal Project name"] === projectCode
      );
      if (!project) {
        console.log('Project not found:', projectCode);
        return;
      }
      let detailsHTML = '';
      for (const category in columnCategories) {
        const categoryColumns = columnCategories[category];
        let hasData = false;
        for (const col of categoryColumns) {
          if (project[col]) {
            hasData = true;
            break;
          }
        }
        if (!hasData) continue;
        detailsHTML += `
          <div class="detail-section">
            <h3>${category}</h3>
            <div class="detail-grid">
        `;
        categoryColumns.forEach(col => {
          if (project[col]) {
            detailsHTML += `
              <div class="detail-item">
                <div class="detail-label">${col}</div>
                <div class="detail-value">${project[col]}</div>
              </div>
            `;
          }
        });
        detailsHTML += `</div></div>`;
      }
      projectDetails.innerHTML = detailsHTML;
      projectModal.classList.add('active');
    }

    // Generate pagination controls
    function generatePagination(totalPages) {
      console.log('Generating pagination for', totalPages, 'pages');
      pagination.innerHTML = '';
      if (totalPages <= 1) return;
      const prevBtn = document.createElement('button');
      prevBtn.className = 'page-btn';
      prevBtn.innerHTML = '&laquo;';
      prevBtn.disabled = currentPage === 1;
      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          displayProjects();
        }
      });
      pagination.appendChild(prevBtn);
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      if (startPage > 1) {
        const firstPageBtn = document.createElement('button');
        firstPageBtn.className = 'page-btn';
        firstPageBtn.textContent = '1';
        firstPageBtn.addEventListener('click', () => {
          currentPage = 1;
          displayProjects();
        });
        pagination.appendChild(firstPageBtn);
        if (startPage > 2) {
          const ellipsis = document.createElement('span');
          ellipsis.textContent = '...';
          ellipsis.style.padding = '8px 12px';
          pagination.appendChild(ellipsis);
        }
      }
      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
        pageBtn.textContent = i;
        pageBtn.addEventListener('click', () => {
          currentPage = i;
          displayProjects();
        });
        pagination.appendChild(pageBtn);
      }
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const ellipsis = document.createElement('span');
          ellipsis.textContent = '...';
          ellipsis.style.padding = '8px 12px';
          pagination.appendChild(ellipsis);
        }
        const lastPageBtn = document.createElement('button');
        lastPageBtn.className = 'page-btn';
        lastPageBtn.textContent = totalPages;
        lastPageBtn.addEventListener('click', () => {
          currentPage = totalPages;
          displayProjects();
        });
        pagination.appendChild(lastPageBtn);
      }
      const nextBtn = document.createElement('button');
      nextBtn.className = 'page-btn';
      nextBtn.innerHTML = '&raquo;';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          displayProjects();
        }
      });
      pagination.appendChild(nextBtn);
    }

    // Export data to CSV
    function exportData() {
      console.log('Exporting data');
      if (filteredProjects.length === 0) {
        alert(i18next.t('noDataToExport'));
        return;
      }
      let csvContent = currentColumns.join(',') + ',Actions\n';
      filteredProjects.forEach(project => {
        const row = currentColumns.map(col => {
          let value = project[col] || '';
          if (typeof value === 'string' && value.includes(',')) {
            return `"${value.replace(/"/g, '""')}"`;
          }
          return value;
        });
        csvContent += row.join(',') + '\n';
      });
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `nbi_projects_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Handle search input
    function handleSearch() {
      const query = searchInput.value.toLowerCase().trim();
      console.log('Searching for:', query);
      if (query === '') {
        filteredProjects = [...allProjects];
      } else {
        filteredProjects = allProjects.filter(project => {
          return (
            (project["Project Code"] && project["Project Code"].toLowerCase().includes(query)) ||
            (project["Project Name"] && project["Project Name"].toLowerCase().includes(query)) ||
            (project["TVET College"] && project["TVET College"].toLowerCase().includes(query)) ||
            (project["Project Status"] && project["Project Status"].toLowerCase().includes(query)) ||
            (project["First Name/s:"] && project["First Name/s:"].toLowerCase().includes(query)) ||
            (project["Surname"] && project["Surname"].toLowerCase().includes(query))
          );
        });
      }
      currentPage = 1;
      displayProjects();
    }

    // Handle Excel file upload
    async function handleExcelUpload(event) {
      console.log('Excel upload initiated');
      const file = event.target.files[0];
      if (!file) {
        console.log('No file selected');
        alert(i18next.t('noFileSelected'));
        return;
      }
      loadingIndicator.style.display = 'block';
      const formData = new FormData();
      formData.append('excelFile', file);
      try {
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });
        if (!response.ok) throw new Error('Failed to upload Excel');
        const result = await response.json();
        alert(i18next.t(result.message, { count: result.count, idCount: result.idCount || 0 }));
        if (result.success) {
          uploadBtn.style.display = 'none';
          excelUpload.style.display = 'none';
          refreshData();
        }
      } catch (error) {
        console.error('Error uploading Excel:', error);
        alert(i18next.t('errorUploadingExcel', { message: error.message }));
      } finally {
        loadingIndicator.style.display = 'none';
        excelUpload.value = '';
      }
    }

    // Event listeners
    function setupEventListeners() {
      closeModal.addEventListener('click', () => projectModal.classList.remove('active'));
      exportBtn.addEventListener('click', exportData);
      refreshBtn.addEventListener('click', refreshData);
      uploadBtn.addEventListener('click', () => excelUpload.click());
      excelUpload.addEventListener('change', handleExcelUpload);
      searchInput.addEventListener('input', handleSearch);
      projectModal.addEventListener('click', (e) => {
        if (e.target === projectModal) projectModal.classList.remove('active');
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && projectModal.classList.contains('active')) {
          projectModal.classList.remove('active');
        }
      });
    }

    // Initialize
    setupEventListeners();
    initializeDashboard();
  </script>
  <script src="../public/Master Page(Header and Footer)/MasterPage.js"></script>
</body>
</html>